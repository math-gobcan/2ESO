<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Juego de Operaciones Combinadas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      background: linear-gradient(120deg, #f8fafc 0%, #b8eaff 100%);
      font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    .top-bar {
      position: fixed;
      top: 16px;
      left: 0;
      right: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 32px;
      width: 100vw;
      max-width: 650px;
      margin: 0 auto;
      background: rgba(255,255,255,0.91);
      border-radius: 16px;
      box-shadow: 0 4px 18px #b8eaff1a;
      backdrop-filter: blur(4px);
    }
    .player-name {
      font-size: 1.22em;
      font-weight: 700;
      color: #0984e3;
      text-shadow: 0 2px 8px #dff9fb88;
      max-width: 40vw;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      letter-spacing: 0.5px;
      background: linear-gradient(90deg, #74b9ff 0%, #00b894 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .score {
      font-size: 1.1em;
      color: #00b894;
      font-weight: 600;
      background: #dff9fbcc;
      border-radius: 8px;
      padding: 7px 18px;
      box-shadow: 0 2px 10px #00b8941a;
      margin-left: 16px;
      letter-spacing: 1px;
      border: 1.5px solid #00b89433;
    }
    .timer {
      font-size: 1.09em;
      font-weight: 600;
      color: #fdcb6e;
      background: #dff9fbcc;
      border-radius: 8px;
      padding: 7px 16px;
      box-shadow: 0 2px 10px #fdcb6e33;
      letter-spacing: 2px;
      border: 1.5px solid #fdcb6e33;
    }
    .main {
      flex: 1 1 auto;
      width: 100vw;
      max-width: 650px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin-top: 110px;
      padding-bottom: 30px;
      min-height: 500px;
    }
    .question-panel {
      background: linear-gradient(120deg, #fff 0%, #dff9fb 100%);
      border-radius: 24px;
      box-shadow: 0 4px 24px #00b89422;
      padding: 38px 7vw 34px 7vw;
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 22px;
      min-width: 0;
      width: 95vw;
      max-width: 470px;
      border: 1.5px solid #00b89422;
      transition: box-shadow 0.15s;
      animation: fadeIn 0.7s;
    }
    .question-panel:hover, .main .question-panel:focus-within {
      box-shadow: 0 6px 32px #00b89444;
    }
    .operation {
      font-size: 2.1em;
      color: #0984e3;
      font-weight: 800;
      letter-spacing: 2px;
      margin-bottom: 8px;
      text-align: center;
      word-break: break-word;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: linear-gradient(90deg, #00b894 0%, #0984e3 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      padding: 5px 0;
    }
    input[type="number"], input[type="text"] {
      font-size: 1.25em;
      border-radius: 16px;
      border: 2.5px solid #0984e3;
      padding: 15px 22px;
      text-align: center;
      width: 140px;
      margin-bottom: 8px;
      background: #f8fafc;
      box-shadow: 0 2px 10px #00b89422;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
    }
    input[type="number"]:focus, input[type="text"]:focus {
      border: 2.5px solid #fdcb6e;
      background: #fff;
      box-shadow: 0 4px 18px #fdcb6e33;
    }
    button {
      font-size: 1.13em;
      background: linear-gradient(90deg, #00b894, #fdcb6e);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 14px 36px;
      box-shadow: 0 2px 10px #fdcb6e22;
      cursor: pointer;
      font-weight: 700;
      width: 100%;
      max-width: 190px;
      margin-top: 2px;
      margin-bottom: 2px;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      letter-spacing: 1px;
      outline: none;
    }
    button:hover, .button-pad button:hover {
      background: linear-gradient(90deg, #0984e3, #00b894);
      box-shadow: 0 4px 18px #0984e344;
      transform: translateY(-2px) scale(1.02);
    }
    button:active, .button-pad button:active {
      background: linear-gradient(90deg, #00b894, #fdcb6e);
      box-shadow: 0 2px 8px #00b89433;
      transform: scale(0.97);
    }
    .feedback {
      font-size: 1.13em;
      margin-top: 8px;
      font-weight: 600;
      min-height: 24px;
      color: #d63031;
      letter-spacing: 1px;
      text-align: center;
      background: #fff1;
      border-radius: 8px;
      padding: 5px 0;
      transition: color 0.2s;
      min-width: 80px;
    }
    .final-message {
      font-size: 1.6em;
      color: #2c2c54;
      font-weight: 800;
      margin-top: 24px;
      background: linear-gradient(90deg, #fdcb6e22 0%, #00b89411 100%);
      border-radius: 22px;
      padding: 26px 6vw;
      box-shadow: 0 6px 32px #fdcb6e44;
      text-align: center;
      animation: pop 0.7s ease;
      border: 1.5px solid #00b89422;
    }
    #nameInput {
      font-size: 1.25em;
      border-radius: 16px;
      border: 2.5px solid #0984e3;
      padding: 15px 22px;
      text-align: center;
      width: 82vw;
      max-width: 320px;
      margin-bottom: 10px;
      background: #f8fafc;
      box-shadow: 0 2px 10px #00b89422;
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
    }
    #nameInput:focus {
      border: 2.5px solid #fdcb6e;
      background: #fff;
      box-shadow: 0 4px 18px #fdcb6e33;
    }
    ::placeholder {
      color: #636e72bb;
      opacity: 1;
      font-size: 1em;
    }
    @keyframes pop {
      0% { transform: scale(0.8); opacity: 0; }
      80% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); }
    }
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(20px);}
      100% { opacity: 1; transform: translateY(0);}
    }
    @media (max-width: 650px) {
      .main, .top-bar {
        max-width: 100vw;
        padding: 0 2vw;
      }
      .question-panel {
        padding: 22px 2vw 22px 2vw;
        max-width: 99vw;
      }
      .final-message {
        padding: 18px 2vw;
        font-size: 1.22em;
      }
      input[type="number"], input[type="text"], #nameInput {
        width: 90vw;
        max-width: 99vw;
        font-size: 1.1em;
        padding: 10px 8px;
      }
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    .button-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-top: 12px;
      width: 100%;
      max-width: 350px;
      padding: 6px 0;
    }

    .button-pad button {
      font-size: 1.5em;
      padding: 17px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #00b894 0%, #fdcb6e 100%);
      color: white;
      font-weight: bold;
      box-shadow: 0 3px 14px #0984e322;
      transition: transform 0.1s ease, background 0.18s;
      outline: none;
    }
    .button-pad button:focus {
      background: linear-gradient(135deg, #0984e3 0%, #00b894 100%);
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div style="display:flex; align-items:center;">
      <div class="player-name" id="playerName"></div>
      <div class="score" id="scorePanel"></div>
    </div>
    <div class="timer" id="timerPanel"></div>
  </div>
  <div class="main" id="mainPanel">
    <div class="question-panel" id="startPanel">
      <div style="font-size: 1.6em; font-weight: 700; color: #0984e3; margin-bottom:10px; background: linear-gradient(90deg, #00b894 0%, #0984e3 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">¡Bienvenido!</div>
      <div style="font-size: 1.13em; margin-bottom:10px; color: #636e72;">Introduce tu nombre para empezar:</div>
      <input type="text" id="nameInput" placeholder="Escribe tu nombre..." maxlength="20" autocomplete="off"/>
      <button onclick="startGame()">Comenzar</button>
    </div>
  </div>
  <script>
    let playerName = '';
    let score = 0;
    let timer = 600;
    let timerInterval = null;
    let gameActive = false;
    let opCount = 0; // operaciones presentadas

    const playerNameDiv = document.getElementById('playerName');
    const scorePanelDiv = document.getElementById('scorePanel');
    const timerPanelDiv = document.getElementById('timerPanel');
    const mainPanelDiv = document.getElementById('mainPanel');
    const startPanelDiv = document.getElementById('startPanel');
    const nameInput = document.getElementById('nameInput');

    function formatTime(sec) {
      let m = Math.floor(sec / 60);
      let s = sec % 60;
      return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function startGame() {
      const name = nameInput.value.trim() || "Jugador";
      playerName = name;
      score = 0;
      timer = 600;
      opCount = 0;
      gameActive = true;
      playerNameDiv.textContent = playerName;
      scorePanelDiv.textContent = `Puntos: ${score}`;
      timerPanelDiv.textContent = formatTime(timer);
      startPanelDiv.style.display = 'none';
      showNewOperation();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function randInt(min, max, avoidZero=false) {
      let n;
      do {
        n = Math.floor(Math.random() * (max - min + 1)) + min;
      } while (avoidZero && n === 0);
      return n;
    }

    // Todos los números con paréntesis y nunca dos símbolos juntos
    function formatNum(n) {
      return `(${n >= 0 ? "+" + n : n})`;
    }

    function generateCombined(opCount) {
      // Dificultad gradual: número de cifras = 2 + Math.floor(opCount/10), máximo 6
      // Solo 1 o 2 multiplicaciones máximo
      let nCount = Math.min(2 + Math.floor(opCount / 10), 6);
      let operators = [];
      let possibleOps = ['+', '-', '·'];
      let nums = [];
      let opMulCount = 0;

      for (let i = 0; i < nCount; i++) {
        nums.push(randInt(-10, 10));
      }
      for (let i = 0; i < nCount - 1; i++) {
        // Decide si poner '·'
        let op;
        if (opMulCount < 2 && Math.random() < 0.25) {
          op = '·';
          opMulCount++;
        } else {
          op = possibleOps[Math.floor(Math.random() * 2)]; // '+' o '-'
        }
        operators.push(op);
      }

      // Construir expresión con jerarquía
      let expr = '';
      if (nCount === 2) {
        expr = `${formatNum(nums[0])} ${operators[0]} ${formatNum(nums[1])}`;
      } else if (nCount === 3) {
        expr = `(${formatNum(nums[0])} ${operators[0]} ${formatNum(nums[1])}) ${operators[1]} ${formatNum(nums[2])}`;
      } else if (nCount === 4) {
        expr = `(${formatNum(nums[0])} ${operators[0]} ${formatNum(nums[1])}) ${operators[1]} (${formatNum(nums[2])} ${operators[2]} ${formatNum(nums[3])})`;
      } else if (nCount === 5) {
        expr = `[(${formatNum(nums[0])} ${operators[0]} ${formatNum(nums[1])}) ${operators[1]} (${formatNum(nums[2])} ${operators[2]} ${formatNum(nums[3])})] ${operators[3]} ${formatNum(nums[4])}`;
      } else if (nCount === 6) {
        expr = `[(${formatNum(nums[0])} ${operators[0]} ${formatNum(nums[1])}) ${operators[1]} [${formatNum(nums[2])} ${operators[2]} (${formatNum(nums[3])} ${operators[3]} ${formatNum(nums[4])})]] ${operators[4]} ${formatNum(nums[5])}`;
      }
      expr = expr.replace(/·/g, '·');
      return {expr, nums, operators};
    }

    function evalCombined(exprStr) {
      let expr = exprStr.replace(/·/g, '*');
      expr = expr.replace(/\+/g, '');
      expr = expr.replace(/\(/g, '(').replace(/\)/g, ')');
      try {
        let r = Math.round(eval(expr));
        return r;
      } catch {
        return NaN;
      }
    }

    function showNewOperation() {
      if (!gameActive) return;
      mainPanelDiv.innerHTML = '';
      opCount++;
      let opData = generateCombined(opCount-1);
      let expr = opData.expr;
      let result = evalCombined(expr);

      while (isNaN(result)) {
        opData = generateCombined(opCount-1);
        expr = opData.expr;
        result = evalCombined(expr);
      }

      const questionPanel = document.createElement('div');
      questionPanel.className = 'question-panel';
      questionPanel.innerHTML = `
  <div class="operation">${expr} = ?</div>
  <input type="text" id="answerInput" autocomplete="off" inputmode="numeric" />
  <div class="button-pad">
    <button onclick="appendChar('1')">1</button>
    <button onclick="appendChar('2')">2</button>
    <button onclick="appendChar('3')">3</button>
    <button onclick="appendChar('4')">4</button>
    <button onclick="appendChar('5')">5</button>
    <button onclick="appendChar('6')">6</button>
    <button onclick="appendChar('7')">7</button>
    <button onclick="appendChar('8')">8</button>
    <button onclick="appendChar('9')">9</button>
    <button onclick="appendChar('+')">+</button>
    <button onclick="appendChar('0')">0</button>
    <button onclick="appendChar('-')">−</button>
    <button onclick="deleteChar()">⌫</button>
  </div>
  <button id="submitBtn">Responder</button>
  <div class="feedback" id="feedbackMsg"></div>
`;

      mainPanelDiv.appendChild(questionPanel);

      document.getElementById('submitBtn').onclick = () => {
        const answer = document.getElementById('answerInput').value.trim();
        const feedbackMsg = document.getElementById('feedbackMsg');
        if (answer === '') {
          feedbackMsg.textContent = 'Introduce una respuesta.';
          feedbackMsg.style.color = '#d63031';
          return;
        }
        let correct = Number(answer) === result;
        if (correct) {
          score += 10;
          feedbackMsg.textContent = '¡Correcto!';
          feedbackMsg.style.color = '#00b894';
        } else {
          score -= 10;
          feedbackMsg.textContent = `Incorrecto. La respuesta era ${result}`;
          feedbackMsg.style.color = '#d63031';
        }
        scorePanelDiv.textContent = `Puntos: ${score}`;
        setTimeout(() => {
          if (gameActive) showNewOperation();
        }, 1100);
      };
      document.getElementById('answerInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') document.getElementById('submitBtn').click();
      });
      document.getElementById('answerInput').focus();
    }

    function updateTimer() {
      timer--;
      timerPanelDiv.textContent = formatTime(timer);
      if (timer <= 0) {
        endGame();
      }
    }

    function endGame() {
      clearInterval(timerInterval);
      gameActive = false;
      timerPanelDiv.textContent = '00:00';
      mainPanelDiv.innerHTML = `
        <div class="final-message">
          ¡Tiempo terminado!<br>
          <span>${playerName}</span>, tu marcador final es:<br>
          <span style="color:#00b894;font-size:2em">${score}</span> puntos
        </div>
      `;
    }

function appendChar(char) {
  const input = document.getElementById('answerInput');
  input.value += char;
}

function deleteChar() {
  const input = document.getElementById('answerInput');
  input.value = input.value.slice(0, -1);
}

  </script>
</body>
</html>
